#!/usr/bin/env node

'use strict';

const args             = require('../lib/argumentor')(process.argv);
const fillOutTheBlanks = require('../lib/fill-out-the-blanks');

if (!args._[1] && process.env.AEWX_URL) {
  args._[1] = process.env.AEWX_URL;
}

if (args.help) {
  console.log(`Usage: aewx-fetch [options...] [ICAO] [AEWX_URL] [FILE]

Copy METAR information from URL into your Aerofly FS2 configuration file.
In default response mode the HTTP response has to contain raw METAR information.

Arguments:
      [ICAO]                 ICAO code of airport the METAR will be fetched for.
                             If this is set to 'XXXX', ICAO code will be fetched
                             from Aerofly FS 2 flightplan departure airport.
                             If this is set to 'YYYY', ICAO code will be fetched
                             from Aerofly FS 2 flightplan arrival airport.
                             If not set this will be asked from STDIN.
      [AEWX_URL]             URL to query, with 'XXXX' being replaced by given
                             ICAO code.
                             You may supply [AEWX_URL] by setting the
                             environment variable 'AEWX_URL'.
                             If not set this will be asked from STDIN.
      [FILE]                 File to modify. Defaults to 'main.mcf' in current
                             path.

Options:
      --response=<TYPE>      Set this to 'json' to parse from a simple JSON
                             object, reading raw METAR from 'root.raw' and other
                             usual places.
      --hours=<HOURS>        Offset time by HOURS hours, e.g. '-8'
      --time=<HH:MM+ZZ:ZZ>   Set time to HH:MM+ZZ:ZZ, e.g. '12:30-08:00'
      --date=<YYYY-MM-DD>    Set date to YYYY-MM-DD, e.g. '2018-12-31'
      --flightplan           Delete currently active flightplan if departure or
                             arrival does not match METAR ICAO code
      --quiet                No console output
      --dry-run              Do not save 'main.mcf'
      --help                 Display this help and exit
      --verbose              Show debug output`);
  process.exit(0);
}

(async() => {
  args._ = await fillOutTheBlanks({
    0: 'an ICAO code',
    1: 'an URL'
  }, args._, 'Please enter %s:');

  require('../lib/main')(args['verbose'])
    .fromUrl(
      args._[1].replace('XXXX', args._[0]),
      args._[2]  || 'main.mcf',
      args
    )
  ;
})();
